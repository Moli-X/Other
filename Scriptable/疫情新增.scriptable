{
  "always_run_in_app" : false,
  "icon" : {
    "color" : "blue",
    "glyph" : "feather-alt"
  },
  "name" : "ã€ŒDJGã€ç–«æƒ…æ–°å¢",
  "script" : "\/*\n\/\/ æŠ–éŸ³æœç´¢ï¼šå¤§èˆ…å“¥ç§‘æŠ€\n\/\/ å¾®ä¿¡æœç´¢å°ç¨‹åºã€Œå¤§èˆ…å“¥ç§‘æŠ€ã€\n\/\/ è·å–æ›´å¤šç²¾ç¾å®ç”¨ iOS æ¡Œé¢ç»„ä»¶ï¼\n\/\/ æ›´å¤šå…è´¹ç²¾é€‰å¿«æ·æŒ‡ä»¤ã€å£çº¸ï¼Œç­‰ä½ ï¼\n\/\/ ***************************\n\/\/ ç¯å¢ƒæ¡†æ¶   ï¼š@ DmYY  \n\/\/ script \t ï¼šåŸä½œè€…Pih ç”±DJGä¿®æ”¹\n*\/\n\nFILE = FileManager.local()\nFILEPATH = FILE.joinPath(FILE.libraryDirectory(), \"\/DJG.js\")\nconst { DJG, Runing } = importModule(FILEPATH);\n\n\/\/ @ç»„ä»¶ä»£ç å¼€å§‹\nclass Widget extends DJG {\n  constructor(arg) {\n    super(arg);\n    this.name = 'ç–«æƒ…æ–°å¢'\n    this.widget_ID = \"DJG-115\"\n    this.version = \"V3.5\";\n    this.covidUrl = \"https:\/\/api.inews.qq.com\/newsqa\/v1\/query\/inner\/publish\/modules\/list?modules=statisGradeCityDetail,diseaseh5Shelf\";\n    \/\/this.covidUrl = \"https:\/\/view.inews.qq.com\/g2\/getOnsInfo?name=disease_h5\";\n    this.city = [\n      'æ±Ÿè‹','äº‘å—','å¹¿ä¸œ','æ¹–å—','æ¹–åŒ—','ä¸Šæµ·','å››å·','å¤©æ´¥','æ²³å—','å±±ä¸œ','ç¦å»º','é™•è¥¿','åŒ—äº¬','é»‘é¾™æ±Ÿ','æµ™æ±Ÿ',\n      'æ²³åŒ—','å®‰å¾½','æ–°ç–†','æ±Ÿè¥¿','é‡åº†','å‰æ—','è¾½å®','å†…è’™å¤','å¹¿è¥¿','å±±è¥¿','ç”˜è‚ƒ','æµ·å—','è´µå·','å®å¤','é’æµ·'];\n\tthis.cityCode = [\n      'jiangsu','yn','gd','hn','hb','sh','cd','tj','henan','sd','fj','xian','bj','helongjiang','zj','hebei','ah',\n      'xinjiang','jiangxi','cq','jilin','ln','neimenggu','guangxi','shanxi','gansu','hainan','guizhou','ningxia','qinghai','xizang'];\n    this.Run(module.filename, args);\n  }\n  \n  \/**\n   * æ¸²æŸ“å‡½æ•°ï¼Œå‡½æ•°åå›ºå®š\n   * å¯ä»¥æ ¹æ® this.widgetFamily æ¥åˆ¤æ–­å°ç»„ä»¶å°ºå¯¸ï¼Œä»¥è¿”å›ä¸åŒå¤§å°çš„å†…å®¹\n   *\/\n  async render () {\n    let widget = this.getWidget();\n    await this.getWidgetBackgroundImage(widget);\n    try{\n      await this.covidData();\n      switch (this.widgetFamily) {\n        case 'small':\n        \tawait this.renderSmall(widget);\n        \tbreak;\n        case 'medium':\n        \tawait this.renderMedium(widget);\n        \tbreak;\n        default:\n        \tawait this.renderMedium(widget, 9);\n        \tbreak;\n      }\n    }catch(e){\n      this.ERROR.push({error:e.toString()});\n    }\n    return widget;\n  }\n  \n  \/\/ å°ç»„ä»¶\n  async renderSmall(w){\n    this.addText(w, 'ğŸ¦  æ¯æ—¥ç–«æƒ…', 13);\n    w.addSpacer()\n    const data = this.settings.coviddata;\n    for(let i = 9; i > 6; i--){\n      const text = w.addStack()\n      this.addText(text, `${data.covid[i].city}ï¼š`, 12);\n      this.addText(text, `+${data.covid[i].confirm}`, 12, {color:'FF3030'});\n      this.addText(w, `ç¡®è¯Šï¼š${data.covid[i].nowConfirm}`, 12, {opacity:0.8});\n      w.addSpacer(4)\n    };\n    this.addText(w, `ä»Šæ—¥æ–°å¢ï¼š${data.total}`, 11, {opacity:0.8});\n  }\n  \n  \/\/ ä¸­ç»„ä»¶\n  async renderMedium(w, num = 3){\n    const body = w.addStack();\n    body.layoutVertically();\n    \n    const topBody = body.addStack()\n    const widgetWidth = this.getWidgetWidthSize('medium')-14\n    topBody.size = new Size(widgetWidth, 45);\n    topBody.addImage(this.makeChart())\n    body.addSpacer(3)\n    const botRow = body.addStack();\n    botRow.layoutVertically();\n    let idex = {url:'', from:'', time:''};\n    const flag = !!this.settings.city;\n    if(!flag){\n      idex.title = 'eventDescription';\n      idex.url = 'eventUrl';\n      idex.from = 'siteName';\n      idex.time = 'eventTime';\n    }else {\n      idex.title = 'title';\n      idex.url = 'news_url';\n      idex.from = 'srcfrom';\n      idex.time = 'publish_time';\n    }\n    const data = await this.covidNews();\n    for(let i = 0; i < num; i++){\n      const list = botRow.addStack()\n      list.size = new Size(widgetWidth, 26)\n      list.addSpacer(4)\n      const _list = list.addStack();\n      _list.layoutVertically();\n      this.addText(_list, data[i][idex.title], 12);\n      const time = flag ? data[i][idex.time] : this.dateFormat('yyyy-MM-dd hh:mm:ss', new Date(parseInt(data[i][idex.time])*1000));\n      this.addText(_list, `${data[i][idex.from]}  ${time}`, 9, {opacity:0.7});\n      list.url = data[i][idex.url];\n      list.addSpacer()\n      if(i+1 != num) botRow.addSpacer(3)\n    }\n  }\n  \n  makeChart(){\n    const chartCanvas = this.makeCanvas(348, 45);\n    const covidData = this.settings.coviddata;\n    const maxh = covidData.covid[9].confirm > 10\n      ? covidData.covid[9].confirm : 30;\n    const diff = maxh\/(40 - 19);\n    let idx = 0;\n    for(let key of covidData.covid){\n      const charth = key.confirm > 0 ? key.confirm\/diff : 0.7\/diff;\n      const x = (idx * 10) + (idx * 15) + 5;\n      const y = 43 - 24\/2 - charth;\n      this.fillRect(chartCanvas, x, y, 14, charth, 3, new Color('FFC125'));\n      this.drawText(chartCanvas, x-3.5, 33, 22, 10, key.city, 'regular', 9, 'center', this.widgetColor);\n      this.drawText(chartCanvas, x-10, y-12, 34, 10, key.confirm.toString(), 'regular', 8, 'center', this.widgetColor);\n      idx ++;\n    }\n    this.drawText(chartCanvas, 250, 0, 100, 15, 'ä»Šæ—¥ç–«æƒ…æ–°å¢', 'regular', 14, 'center', this.widgetColor);\n    this.drawText(chartCanvas, 261, 19, 80, 25, '+'+covidData.total, 'bold', 21, 'center', new Color('FF3030'));\n    return chartCanvas.getImage();\n  }\n  \n  \/\/ è·å–ç–«æƒ…æ•°æ®\n  async covidData(){\n    let KEY = this.SETTING_KEY+this.widget_ID;\n    const flag = !this.settings.coviddata;\n    if(this.isUpdate(KEY,0.5,true) || flag){\n      let json = {total:0,covid:[]};\n      let coviddata = await this.httpGet(this.covidUrl);\n      let data = coviddata.data.diseaseh5Shelf.areaTree[0];\n      let arr = [];\n      for(let key of data.children.splice(0, 10)){\n        let children = {confirm:0, city:'--', nowConfirm:0};\n        children.confirm = key.today.confirm;\n        children.city = key.name;\n        children.nowConfirm = key.total.nowConfirm;\n        arr.push(children)\n      }\n      arr.sort(function(a,b){return a.confirm - b.confirm})\n      json.total = data.today.confirm;\n      json.covid = arr;\n      this.settings.coviddata = json;\n      this.saveSettings(false);\n    }\n  }\n  \n  \/\/ ç–«æƒ…èµ„è®¯\n  async covidNews(){\n    if(!this.settings.city){\n      let covidNewsURL = \"https:\/\/opendata.baidu.com\/data\/inner?tn=reserved_all_res_tn&dspName=iphone&from_sf=1&dsp=iphone&resource_id=28565&alr=1&query=%E5%9B%BD%E5%86%85%E6%96%B0%E5%9E%8B%E8%82%BA%E7%82%8E%E6%9C%80%E6%96%B0%E5%8A%A8%E6%80%81\";\n      let data = (await this.httpGet2(covidNewsURL)).Result[0].items_v2[0].aladdin_res.DisplayData.result.items;\n      return data;\n    } else {\n      if(this.city.indexOf(this.settings.city) != -1){\n      \tlet cityID = this.cityCode[this.city.indexOf(this.settings.city)];\n      \tif(cityID){\n          let covidNewsURL = `https:\/\/api.dreamreader.qq.com\/news\/v1\/province\/news\/list?province_code=${cityID}&page_size=10`;\n          let covidNews = await this.httpGet(covidNewsURL);\n          return covidNews.data.items\n        }\n      }else {logError(\"Errorï¼šç–«æƒ…èµ„è®¯åœ°åŒºè®¾ç½®é”™è¯¯ï¼\")};\n    }\n  }\n  \n  async httpGet2 (url, json = true, useCache = true, options = null, method = 'GET') {\n    let cacheKey = this.hash('channel.chinanews.com');\n    let cacheData = null, error = null;\n    if (this.isUpdate(cacheKey.slice(-8), useCache) || !Keychain.contains(cacheKey)){\n      try {\n        let req = new Request(url)\n        req.method = method\n        if(options){\n          Object.keys(options).forEach((key) => {\n            req[key] = options[key];\n          });\n        }\n        cacheData = await (json ? req.loadJSON() : req.loadString());\n      } catch (e) {\n        error = {url:url, error:e.toString()};\n        this.writeError(error);\n      };\n    }\n    if(cacheData && useCache) {\n      this.saveCacheKey(cacheKey);\n      Keychain.set(cacheKey, json ? JSON.stringify(cacheData) : cacheData)\n    }else if (!cacheData && Keychain.contains(cacheKey)) {\n      let cache = Keychain.get(cacheKey)\n      cacheData = json ? JSON.parse(cache) : cache\n    }else {this.ERROR.push(error);}\n    return cacheData;\n  }\n  \n  \/\/ æ·»åŠ è®¾ç½®ä¿¡æ¯\n  Run(filename, args) {\n    if (config.runsInApp) {\n      this.registerAction(\"åŸºç¡€è®¾ç½®\", this.setWidgetConfig);\n      this.registerAction(\"åœ°åŒºè®¾ç½®\", async () => {\n        await this.setCustomAction(\"åœ°åŒºè®¾ç½®\", \"è®¾ç½®åœ°åŒºç–«æƒ…æœ€æ–°èµ„è®¯\\næ¸¯æ¾³å°åœ°åŒºä¸æ”¯æŒ\\næ­£ç¡®è¾“å…¥çœä»½åœ°åŒº\\nä¾‹å¦‚ï¼šå¹¿ä¸œ\", {\n          city: \"æ¸¯æ¾³å°åœ°åŒºä¸æ”¯æŒ\",\n        },this.city);\n      }, { name: 'location.circle', color: '#66CD00' });\n    }\n  }\n}\n\/\/ @ç»„ä»¶ä»£ç ç»“æŸ\nawait Runing(Widget)\n\n",
  "share_sheet_inputs" : [

  ]
}
